const card1 = [{
    "bounding": { "height": 321, "left": 261, "top": 142, "width": 887 },
    "lines": [{ "bounding": { "height": 322, "left": 261, "top": 141, "width": 886 }, "elements": [[Object]], "text": "KPMG" }],
    "text": "KPMG"
},
{
    "bounding": { "height": 379, "left": 252, "top": 612, "width": 1368 },
    "lines": [{
        "bounding": { "height": 380, "left": 252, "top": 611, "width": 1367 }, "elements": [[Object], [Object], [Object]],
        "text": "WIKi WK. Ng"
    }], "text": "WIKi WK. Ng"
},
{
    "bounding": { "height": 107, "left": 241, "top": 1155, "width": 688 },
    "lines": [{ "bounding": { "height": 107, "left": 241, "top": 1155, "width": 688 }, "elements": [[Object]], "text": "Consultant" }],
    "text": "Consultant"
},
{
    "bounding": { "height": 148, "left": 234, "top": 1305, "width": 2068 },
    "lines": [{ "bounding": { "height": 148, "left": 234, "top": 1305, "width": 2068 }, "elements": [[Object], [Object], [Object]], "text": "Advisory, Management Consulting" }],
    "text": "Advisory, Management Consulting"
},
{
    "bounding": { "height": 392, "left": 2537, "top": 1570, "width": 1329 },
    "lines": [
        { "bounding": { "height": 99, "left": 2537, "top": 1570, "width": 152 }, "elements": [[Object]], "text": "Tel" },
        { "bounding": { "height": 116, "left": 2551, "top": 1700, "width": 1314 }, "elements": [[Object], [Object], [Object], [Object]], "text": "Direct +852 2978 8988" },
        { "bounding": { "height": 100, "left": 2549, "top": 1863, "width": 190 }, "elements": [[Object]], "text": "Fax" }],
    "text": "Tel Direct + 852 2978 8988 Fax"
},
{
    "bounding": { "height": 109, "left": 2970, "top": 1559, "width": 888 },
    "lines": [{ "bounding": { "height": 110, "left": 2970, "top": 1558, "width": 887 }, "elements": [[Object], [Object], [Object]], "text": "+852 2522 6022" }],
    "text": " + 852 2522 6022"
},
{
    "bounding": { "height": 413, "left": 227, "top": 1575, "width": 2073 },
    "lines": [
        { "bounding": { "height": 146, "left": 237, "top": 1574, "width": 2059 }, "elements": [[Object], [Object], [Object], [Object], [Object]], "text": "KPMG Advisory (Hong Kong) Limited" },
        { "bounding": { "height": 124, "left": 227, "top": 1732, "width": 1484 }, "elements": [[Object], [Object], [Object], [Object]], "text": "8th Floor, Prince's Building" },
        { "bounding": { "height": 101, "left": 235, "top": 1888, "width": 845 }, "elements": [[Object], [Object], [Object]], "text": "10 Chater Road" }],
    "text": `KPMG Advisory(Hong Kong) Limited 
            8th Floor, Prince's Building 
            10 Chater Road`
},
{
    "bounding": { "height": 123, "left": 2979, "top": 1842, "width": 893 },
    "lines": [{ "bounding": { "height": 124, "left": 2979, "top": 1841, "width": 892 }, "elements": [[Object], [Object], [Object]], "text": "+852 2845 2588" }],
    "text": " + 852 2845 2588"
},
{
    "bounding": { "height": 126, "left": 225, "top": 2034, "width": 1085 },
    "lines": [{ "bounding": { "height": 126, "left": 225, "top": 2034, "width": 1085 }, "elements": [[Object], [Object], [Object]], "text": "Central, Hong Kong" }],
    "text": "Central, Hong Kong"
},
{
    "bounding": { "height": 126, "left": 2551, "top": 2002, "width": 1077 },
    "lines": [{ "bounding": { "height": 126, "left": 2551, "top": 2002, "width": 1077 }, "elements": [[Object]], "text": "wiki.ng@kpmg.com" }],
    "text": "wiki.ng@kpmg.com"
},
{
    "bounding": { "height": 129, "left": 225, "top": 2345, "width": 3033 },
    "lines": [{ "bounding": { "height": 130, "left": 225, "top": 2344, "width": 3033 }, "elements": [[Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object]], "text": "KPMG Advisory (Hong Kong) Limited is a Hong Kong limited liability company." }],
    "text": "KPMG Advisory(Hong Kong) Limited is a Hong Kong limited liability company."
}]

const card2 = [{
    "bounding": { "height": 702, "left": 1283, "top": 54, "width": 2458 },
    "lines": [
        { "bounding": { "height": 148, "left": 1290, "top": 54, "width": 2451 }, "elements": [[Object], [Object], [Object], [Object], [Object], [Object], [Object]], "text": "Chi Che Ying, Toby Bachelor of Business" },
        { "bounding": { "height": 130, "left": 1290, "top": 231, "width": 836 }, "elements": [[Object], [Object]], "text": "Unit Manager" },
        { "bounding": { "height": 150, "left": 1283, "top": 368, "width": 1895 }, "elements": [[Object], [Object], [Object]], "text": "Wealth Management Manager" },
        { "bounding": { "height": 131, "left": 1288, "top": 515, "width": 1707 }, "elements": [[Object], [Object], [Object], [Object], [Object]], "text": "Insurance Agent Reg. No: 15268888" },
        { "bounding": { "height": 121, "left": 1287, "top": 634, "width": 1662 }, "elements": [[Object], [Object], [Object], [Object], [Object]], "text": "MPF Intermediary Reg. No: 113588" }],
    "text": `Chi Che Ying, Toby Bachelor of Business
            Unit Manager
            Wealth Management Manager
            Insurance Agent Reg. No: 15268888
            MPF Intermediary Reg. No: 113588`},
{
    "bounding": { "height": 293, "left": 1281, "top": 1085, "width": 2063 },
    "lines": [
        { "bounding": { "height": 161, "left": 1281, "top": 1084, "width": 2060 }, "elements": [[Object], [Object], [Object]], "text": "Authorized representative of" },
        { "bounding": { "height": 134, "left": 1281, "top": 1245, "width": 1781 }, "elements": [[Object], [Object], [Object]], "text": "AIA International Limited" }],
    "text": `Authorized representative of 
            AIA International Limited`},
{
    "bounding": { "height": 879, "left": 1261, "top": 1463, "width": 2447 },
    "lines": [
        { "bounding": { "height": 130, "left": 1289, "top": 1466, "width": 1969 }, "elements": [[Object], [Object], [Object], [Object], [Object], [Object]], "text": "Rm 2902, 29/F, AlIA Kowloon Tower," },
        { "bounding": { "height": 143, "left": 1293, "top": 1612, "width": 2400 }, "elements": [[Object], [Object], [Object], [Object], [Object], [Object], [Object]], "text": "100 How Ming Street, Kwun Tong, Kowloon" },
        { "bounding": { "height": 175, "left": 1286, "top": 1746, "width": 2418 }, "elements": [[Object], [Object], [Object], [Object], [Object], [Object], [Object], [Object]], "text": "D: (852) 2240 0129 F: (852) 2240 0122" },
        { "bounding": { "height": 135, "left": 1287, "top": 1924, "width": 1108 }, "elements": [[Object], [Object], [Object], [Object]], "text": "M: (852) 6613 1789" },
        { "bounding": { "height": 150, "left": 1265, "top": 2065, "width": 1358 }, "elements": [[Object], [Object]], "text": "E: tobychi@aia.com.hk" },
        { "bounding": { "height": 105, "left": 1282, "top": 2237, "width": 737 }, "elements": [[Object]], "text": "AIA.COM.HK" }],
    "text": `Rm 2902, 29/F, AlIA Kowloon Tower,
            100 How Ming Street, Kwun Tong, Kowloon
            D: (852) 2240 0129 F: (852) 2240 0122
            M: (852) 6613 1789
            E: tobychi@aia.com.hk
            AIA.COM.HK`}]

const maxLogoHeight = 400
const allowableLineSpacing = 230
const allowableLeftMargin = 500//20
const allowableLineSpacingDiff = 30
const phoneFormat = /\s*(?:\+?[-. (]*(\d{1,3}))?[-. )]*(\d{4})[-. ]*(\d{4})(?: *x(\d+))?\s*/
const emailFormat = /\s*\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+\s*/;
const districtName = /Hong Kong|Kowloon|New Territories|NT|N.T/

export function CardFormatter(data = card1) {
    console.log("converting card info")

    //1. determine tel number, e.g. Tel, Direct, D:, F:, M:, +, (852) -> get number
    //2. determine email
    //3. try to determine company name, end with "limited, corporation"
    //4. determine job titles
    //5. determine name, split to first name/ last name from email and compare to other
    //6. group address by item more than one lines, from last to front
    //remove each row after found

    let formattedInfo = {}

    let categorys = []
    let categoryIndex = 0;

    let first_name = ""
    let last_name = ""
    let telInfos = []

    let maxLineHeight = 0

    let remainingLines = []

    for (let lineData of data) {

        for (let line of lineData.lines) {
            //console.log(line)            
            let lineContent = line.text
            //console.log("Line orginal : ", lineContent)
            if (line.text.match(emailFormat)) {
                //console.log("line should have email", line.text, " , result: ", line.text.match(emailFormat))
                formattedInfo['email'] = (line.text.match(emailFormat))[0].trim()
                let name = formattedInfo['email'].split("@")[0] //.split["."]
                name = name.split(".")
                //console.log("email name: ", name)
                first_name = toCapitalise(name[0])
                last_name = name.length > 1 ? toCapitalise(name[name.length - 1]) : ""
                lineContent = ""
            }

            for (let wordInLine of line.text.split(" ")) {
                switch (true) {
                    case (/Telephone|Tel|T:|T /i.test(wordInLine)): //i flag ignore case  
                        //console.log('Case 1: tel');
                        categorys.push({ lineTop: line.bounding.top, item: "office" });
                        lineContent = lineContent.replace(wordInLine, "")
                        //console.log('line content: ' + lineContent)
                        break;
                    case (/Mobile|M:|M /i.test(wordInLine)):
                        //console.log('Case 3: mobile');
                        categorys.push({ lineTop: line.bounding.top, item: "mobile" });
                        lineContent = lineContent.replace(wordInLine, "")
                        break;
                    case (/Fax|F:|F /i.test(wordInLine)):
                        //console.log('Case 4: fax');
                        categorys.push({ lineTop: line.bounding.top, item: "fax" });
                        lineContent = lineContent.replace(wordInLine, "")
                        break;
                    case (/Direct|D:|D /i.test(wordInLine)):
                        //console.log('Case 2: direct: ', /Direct Fax|DF:|DF /i.test(wordInLine));
                        categorys.push({ lineTop: line.bounding.top, item: "direct" });
                        lineContent = lineContent.replace(wordInLine, "")
                        break;
                    case (/Limited|Ltd|Corp|Company/i.test(wordInLine)):
                        //console.log('Case 5: company name');
                        //console.log("line should have company name: ", line)
                        let checkComma = line.text.split(",")
                        if (checkComma[1]) {
                            console.log("Count: ", checkComma[1].trim().search(/\s/))
                            if (checkComma[1].trim().search(/\s/) > -1) {
                                continue;
                            }
                        }
                        let lastWord = checkComma[0].split(" ").slice(-1) //+ (checkComma[1]? checkComma[1].substring(0,8) : "")
                        //console.log("Last word is ", lastWord)
                        if (/Limited/.test(lastWord) | /Ltd?(.)?/.test(lastWord) | /Corp?(.,+)?/.test(lastWord) | /Company/.test(lastWord)) {
                            console.log("company name: ", line.text.trim())
                            formattedInfo['company_name'] = line.text.trim()
                        }
                        //console.log("removed company line:", line.text)
                        lineContent = ""
                        break;
                };
            }

            if (line.bounding.height > maxLineHeight && line.bounding.top < maxLogoHeight) {
                maxLineHeight = line.bounding.height
            }

            if (lineContent.trim() != "")
                remainingLines.push({ lineTop: line.bounding.top, lineLeft: line.bounding.left, lineHeight: line.bounding.height,lineWidth: line.bounding.width, text: lineContent })
        }
    }

    remainingLines = remainingLines.sort((a, b) => {
        return b["lineTop"] < a["lineTop"] ? 1 : -1
    })
    console.log("remaining lines: ", remainingLines)
    //console.log("Categorys: ", categorys)
    console.log("first name: ", first_name, " ; last name: ", last_name)
    let addressMapping = []
    for (let i = 0; i < remainingLines.length; i++) {
        let lineContent = remainingLines[i].text

        if (remainingLines[i].lineHeight == maxLineHeight && !formattedInfo['company_name']) {
            formattedInfo['company_name'] = remainingLines[i].text
            remainingLines[i] = { ...remainingLines[i], text: "" }
            continue
        }

        //console.log("second checking line: ", lineContent)
        if (remainingLines[i].text.match(phoneFormat) && categorys.length > 0 && remainingLines[i].lineTop >= categorys[categoryIndex].lineTop - allowableLineSpacingDiff) {
            let lineResult = lineContent.match(phoneFormat)
            while (lineResult !== null) {
                let telInfo = {}
                telInfo["index"] = categoryIndex
                telInfo["country_code"] = lineResult[1]
                telInfo["tel_number"] = lineResult[2] + lineResult[3]
                telInfo["category"] = categorys[categoryIndex].item
                //console.log("Tel info: ", telInfo)
                telInfos.push(telInfo)
                lineContent = lineContent.replace(lineResult[0], "")
                //console.log("Tel infos: ", telInfos)
                lineResult = lineContent.match(phoneFormat)
                //console.log("line result: ", lineResult)
                categoryIndex += 1
            }
        }

        if (lineContent.trim().length > 0) {
            if (last_name != "") {
                let capLineContent = []
                for (let word of lineContent.split(" ")) {
                    capLineContent.push(toCapitalise(word.toLowerCase()))
                }
                //console.log("second checking match: ", capLineContent.join(" ").match(last_name), " in ", capLineContent.join(" "))
                if (capLineContent.join(" ").match(last_name)) {
                    formattedInfo["last_name"] = last_name
                    formattedInfo["first_name"] = first_name
                    formattedInfo["title"] = remainingLines[i + 1].text
                    continue
                }
            } else if (first_name != "") {
                for (let word of lineContent.split(" ")) {
                    word = word.toLowerCase()
                    console.log("second checking word: ", word, " with ", first_name.toLowerCase())
                    if (first_name.toLowerCase().match(word)) {
                        let name_index = 0
                        // console.log("First name: ", first_name.match(word))
                        if (first_name.toLowerCase().match(word).index == 0) {
                            formattedInfo["first_name"] = toCapitalise(word)
                            formattedInfo["title"] = remainingLines[i + 1].text
                        } else {
                            if (name_index < first_name.toLowerCase().match(word).index) {
                                formattedInfo["last_name"] = toCapitalise(word)
                                formattedInfo["title"] = remainingLines[i + 1].text
                            }
                        }
                    }
                }
            }

            if (lineContent.match(districtName)) {
                console.log("this line have address: ", lineContent, " ", remainingLines[i])
                let lineIndexMap = [i]
                let checkedIndex = i
                let lineLeft = remainingLines[i].lineLeft
                while (remainingLines[checkedIndex].lineTop - remainingLines[checkedIndex - 1].lineTop <= allowableLineSpacing) {
                    console.log("left margin diff: ",Math.abs(remainingLines[checkedIndex].lineLeft - remainingLines[checkedIndex - 1].lineLeft), " ", checkedIndex)
                    if (Math.abs(lineLeft - remainingLines[checkedIndex - 1].lineLeft) > allowableLeftMargin) {
                        
                        console.log("omitted margin: ", remainingLines[checkedIndex].text, " ",remainingLines[checkedIndex], " ",
                        remainingLines[checkedIndex - 1], " ", checkedIndex)
                        checkedIndex -= 1
                        continue
                    }
                    checkedIndex -= 1
                    lineIndexMap.push(checkedIndex)
                    console.log("checked margin: ", remainingLines[checkedIndex].text)
                }
                addressMapping.push({ lineTop: remainingLines[i].lineTop, lineIndex: lineIndexMap })
            }
        }
        remainingLines[i] = { ...remainingLines[i], text: lineContent.trim() }

    }
    addressMapping = addressMapping.sort((a, b) => {
        return b["lineIndex"].length > a["lineIndex"].length ? 1 : -1
    })
    console.log("sorted address: ", addressMapping)

    let address = ""
    for (let lineIndex of addressMapping[0].lineIndex.sort()) {
        address += remainingLines[lineIndex].text
        console.log("check last word: ", remainingLines[lineIndex].text.split(" ").slice(-1))
        if (!(/,/.test(remainingLines[lineIndex].text.split(" ").slice(-1)))) {
            address += "\n"
        }
        address += " "
    }
    console.log("address: ", address)
    formattedInfo['address'] = address.trim()
    formattedInfo['tel'] = telInfos

    if (!formattedInfo["first_name"])
        formattedInfo["first_name"] = ""

    if (!formattedInfo["last_name"])
        formattedInfo["last_name"] = ""

    if (!formattedInfo["title"])
        formattedInfo["title"] = ""

    if (!formattedInfo["company_name"])
        formattedInfo["company_name"] = ""

    if (!formattedInfo["email"])
        formattedInfo["email"] = ""

    console.log("result: ", formattedInfo)
    //console.log("remaining lines2: ", remainingLines)
    return formattedInfo
}

function toCapitalise(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
}